THEME_NAME="$(cat "$HOME/.config/custom-themes/.current" 2>/dev/null)"
THEME_NAME="${THEME_NAME:-macchiato}"
# shellcheck source=/dev/null
. "$HOME/.config/custom-themes/$THEME_NAME.sh"
sed 's/^export //' "$HOME/.config/custom-themes/$THEME_NAME.sh" >"$HOME/.config/tmux/conf/current_theme.conf"

theme="\
    --color=bg+:$COLOR_surface,bg:-1,spinner:$COLOR_flamingo,hl:$COLOR_subtext \
    --color=fg:$COLOR_subtle,header:$COLOR_red,info:$COLOR_mauve,pointer:$COLOR_mauve \
    --color=gutter:$COLOR_surface \
    --color=border:$COLOR_text \
    --color=marker:$COLOR_flamingo,fg+:$COLOR_text,prompt:$COLOR_mauve,hl+:bold:$COLOR_blue"

export FZF_DEFAULT_COMMAND="fd --type f"
export FZF_DEFAULT_OPTS="
    --layout=default
    --multi \
    --preview-window=right:50% \
    --preview-window=rounded \
    --preview-window=cycle \
    --scrollbar '▌' \
    --marker '+' \
    --prompt ' ' \
    --no-separator \
    --bind 'esc:abort' \
    --no-clear \
    $theme \
"

export FZF_CTRL_T_COMMAND="fd --type f --hidden --strip-cwd-prefix --exclude .git"
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:200 {}'"
export FZF_ALT_C_COMMAND="fd --type d --hidden --strip-cwd-prefix --exclude .git"
export FZF_ALT_C_OPTS="--preview 'eza --tree --level 1 --group-directories-first --color=always --icons {}'"
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window=up:3:hidden:wrap --bind '?:toggle-preview'"

_fzf_compgen_path() {
    fd --hidden --exclude .git . "$1"
}

_fzf_compgen_dir() {
    fd --type=d --hidden --exclude .git . "$1"
}

if [ ! -d "$HOME/.terminfo" ]; then
    local tempfile
    case "$TERM" in
    wezterm)
        tempfile=$(mktemp) &&
            curl -so "$tempfile" https://raw.githubusercontent.com/wez/wezterm/master/termwiz/data/wezterm.terminfo &&
            tic -x -o "$HOME/.terminfo" "$tempfile" &&
            rm "$tempfile"
        ;;
    ghostty | xterm-ghostty)
        tempfile=$(mktemp) &&
            curl -so "$tempfile" https://raw.githubusercontent.com/rachartier/dotfiles/refs/heads/main/.config/ghostty/terminfo/ghostty.terminfo &&
            tic -x -o "$HOME/.terminfo" "$tempfile" &&
            rm "$tempfile"
        ;;
    esac
fi

if [ -z "$DOTFILES_DOCKER" ]; then
    export FZF_TMUX=1
    export FZF_TMUX_OPTS="-p80%,60%"
    export ZSH_TMUX_AUTOSTART=false
    export ZSH_TMUX_CONFIG="$HOME/.config/tmux/tmux.conf"
    export DISABLE_AUTO_TITLE="true"

    if [[ -n "$SSH_CONNECTION" ]]; then
        export EDITOR="vim"
        export VISUAL="vim"
    else
        export EDITOR="nvim"
        export VISUAL="nvim"
    fi
else
    [ -z "$LC_ALL" ] && export LC_ALL=C

    # For copilot.vim
    export NODE_TLS_REJECT_UNAUTHORIZED=0
    export APPIMAGE_EXTRACT_AND_RUN=1
fi

typeset -U path # deduplicate PATH entries

path=(
    "$HOME/.dotnet"
    "$HOME/.dotnet/tools"
    $path
    "/opt/nvim-linux-x86_64/bin"
    "/snap/bin"
    "$HOME/.local/bin"
    "$HOME/.fzf/bin"
    "$HOME/.local/share/nvim/mason/bin"
    "$HOME/.opencode/bin"
)

export PATH

export KEYTIMEOUT=10
export DOTNET_ROOT="$HOME/.dotnet"
export MANPAGER="sh -c 'col -bx | bat -l man -p'"
export MANROFFOPT="-c"
export SUDO_EDITOR="nvim"
export BROWSER="/mnt/c/Program Files/Mozilla Firefox/firefox.exe"
export GALLIUM_DRIVER=d3d12
export COPILOT_ALLOW_ALL="true"

[ -z "$COLORTERM" ] && export COLORTERM=truecolor
